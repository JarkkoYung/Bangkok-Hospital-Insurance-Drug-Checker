<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Bangkok Hospital Insurance Drug Checker</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root {
    --purple: #6b63d1;
    --green-bg: #eef7ee;
    --green-border: #7bc47f;
    --red-bg: #fdeeee;
    --red-border: #e07a7a;
  }

  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f5f6fa;
    margin: 0;
    padding: 16px;
  }

  .container {
    max-width: 900px;
    margin: auto;
    background: #fff;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.05);
  }

  h1 {
    margin-top: 0;
    font-size: 28px;
  }

  label {
    display: block;
    margin-top: 18px;
    font-weight: 600;
  }

  input, select, button {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid #ccc;
  }

  button {
    margin-top: 22px;
    background: var(--purple);
    color: #fff;
    border: none;
    font-weight: 600;
    cursor: pointer;
  }

  .results {
    margin-top: 28px;
  }

  .card {
    border-left: 6px solid;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 14px;
  }

  .covered {
    background: var(--green-bg);
    border-color: var(--green-border);
  }

  .not-covered {
    background: var(--red-bg);
    border-color: var(--red-border);
  }

  .company {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 6px;
  }

  .badges {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 6px;
  }

  .badge {
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 600;
  }

  .ok {
    background: #dff2e1;
    color: #1f7a35;
  }

  .no {
    background: #f9d6d6;
    color: #8a1f1f;
  }

  footer {
    text-align: center;
    margin-top: 32px;
    color: #999;
    font-size: 14px;
  }
</style>
</head>

<body>
<div class="container">
  <h1>Bangkok Hospital Insurance Drug Checker</h1>

  <label>Drug name</label>
  <input id="drugInput" placeholder="e.g. para" />

  <label>Service scope</label>
  <select id="scopeInput">
    <option value="OPD">OPD</option>
    <option value="IPD">IPD</option>
    <option value="ER">ER</option>
    <option value="ICU">ICU</option>
  </select>

  <button onclick="check()">Check coverage</button>

  <div class="results" id="results"></div>
</div>

<footer>Designed by Jarkko</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const db = window.__db || supabase.createClient(
  "https://dtfekjqhnyywjneutbli.supabase.co",
  "sb_publishable_ufJ1KgttNIqvmS46kK8P7g_HuYpAQ5N"
);
window.__db = db;

async function check() {
  results.innerHTML = "";
  const keyword = drugInput.value.trim().toLowerCase();
  if (!keyword) return;

  // âœ… å®Œç¾Ž index æ ¸å¿ƒç²¾ç¥žï¼šå…ˆå…¨æ‹¿ï¼Œå†åœ¨å‰ç«¯ç­›
  const { data: rules, error } = await db
    .from("coverage_rule")
    .select("*");

  if (error) {
    results.textContent = "ERROR: " + error.message;
    return;
  }

  // ðŸ” åœ¨æ‰€æœ‰ string å­—æ®µé‡Œæ‰¾ para
  const matched = rules.filter(r =>
    Object.values(r).some(v =>
      typeof v === "string" && v.toLowerCase().includes(keyword)
    )
  );

  if (matched.length === 0) {
    results.textContent = "No coverage data found.";
    return;
  }

  // æ‹¿ä¿é™©å…¬å¸
  const companyIds = [...new Set(matched.map(r => r.insurance_company_id))];
  const { data: companies } = await db
    .from("insurance_company")
    .select("*")
    .in("id", companyIds);

  // å½’å¹¶
  const grouped = {};
  matched.forEach(r => {
    const company = companies.find(c => c.id === r.insurance_company_id);
    if (!grouped[r.insurance_company_id]) {
      grouped[r.insurance_company_id] = {
        name: company?.name || "Unknown",
        rules: []
      };
    }
    grouped[r.insurance_company_id].rules.push(r);
  });

  Object.values(grouped).forEach(g => {
    const hasCovered = g.rules.some(r => r.coverage_status === "COVERED");
    const card = document.createElement("div");
    card.className = "card " + (hasCovered ? "covered" : "not-covered");

    card.innerHTML = `
      <div class="company">${g.name}</div>
      <div class="badges">
        ${g.rules.map(r => `
          <span class="badge ${r.coverage_status === "COVERED" ? "ok" : "no"}">
            ${r.service_scope}
          </span>
        `).join("")}
      </div>
    `;
    results.appendChild(card);
  });
}
</script>
</body>
</html>
