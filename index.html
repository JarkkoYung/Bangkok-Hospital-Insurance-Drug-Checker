<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bangkok Hospital Insurance Drug Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
      background: #f4f6fa;
      color: #1f2937;
    }

    .container {
      max-width: 900px;
      margin: 60px auto;
      background: white;
      padding: 48px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.08);
    }

    h1 {
      margin: 0 0 8px;
      font-size: 36px;
    }

    .subtitle {
      color: #6b7280;
      margin-bottom: 32px;
    }

    label {
      font-weight: 600;
      margin-top: 24px;
      display: block;
    }

    input, select, button {
      width: 100%;
      margin-top: 8px;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      font-size: 16px;
    }

    button {
      margin-top: 32px;
      background: #2563eb;
      color: white;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }

    button:hover {
      background: #1e40af;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 32px;
    }

    th, td {
      padding: 14px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    th {
      background: #f9fafb;
      font-weight: 600;
    }

    .logo {
      height: 32px;
    }

    .status-covered {
      color: #16a34a;
      font-weight: 600;
    }

    .status-not {
      color: #dc2626;
      font-weight: 600;
    }

    .footer {
      margin-top: 48px;
      text-align: center;
      font-size: 13px;
      color: #9ca3af;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Bangkok Hospital Insurance Drug Checker</h1>
    <div class="subtitle">Check insurance coverage by drug and service scope</div>

    <label>Drug name</label>
    <input id="drugInput" placeholder="e.g. Paracetamol" />

    <label>Service scope</label>
    <select id="serviceScopeSelect">
      <option>Loading...</option>
    </select>

    <button onclick="checkCoverage()">Check coverage</button>

    <div id="result"></div>

    <div class="footer">
      This software is designed by Jarkko
    </div>
  </div>

<script>
/* =========================
   Supabase init (FIXED)
========================= */
const SUPABASE_URL = "https://dtfekjqhnyywjneutbli.supabase.co";
const SUPABASE_KEY = "sb_publishable_ufJ1KgttNIqvmS46kK8P7g_HuYpAQ5N";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =========================
   Load service scopes
========================= */
async function loadServiceScopes() {
  const { data, error } = await supabase
    .from("service_scope")
    .select("*")
    .eq("is_active", true)
    .order("id");

  if (error) {
    console.error(error);
    return;
  }

  const select = document.getElementById("serviceScopeSelect");
  select.innerHTML = "";

  data.forEach((s, index) => {
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = s.name;
    if (s.code === "OPD") opt.selected = true;
    select.appendChild(opt);
  });
}

/* =========================
   Main search
========================= */
async function checkCoverage() {
  const drugName = document.getElementById("drugInput").value.trim();
  const scopeId = document.getElementById("serviceScopeSelect").value;
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = "Searching...";

  if (!drugName) {
    resultDiv.innerHTML = "Please enter a drug name.";
    return;
  }

  const { data: drugs, error: drugError } = await supabase
    .from("drug")
    .select("*")
    .or(`generic_name.ilike.%${drugName}%,brand_name.ilike.%${drugName}%`);

  if (drugError || !drugs.length) {
    resultDiv.innerHTML = "No drug found.";
    return;
  }

  const drugIds = drugs.map(d => d.id);

  const { data: rules, error: ruleError } = await supabase
    .from("coverage_rule")
    .select(`
      coverage_status,
      condition_text,
      insurance_company (
        name,
        logo_url
      )
    `)
    .in("drug_id", drugIds)
    .eq("service_scope_id", scopeId);

  if (ruleError || !rules.length) {
    resultDiv.innerHTML = "No coverage rules found.";
    return;
  }

  renderTable(rules);
}

/* =========================
   Render result table
========================= */
function renderTable(rows) {
  let html = `
    <button onclick="exportCSV()">Export CSV</button>
    <table>
      <tr>
        <th>Insurance</th>
        <th>Status</th>
        <th>Condition</th>
      </tr>
  `;

  rows.forEach(r => {
    html += `
      <tr>
        <td>
          ${r.insurance_company.logo_url
            ? `<img class="logo" src="${r.insurance_company.logo_url}">`
            : r.insurance_company.name}
        </td>
        <td class="${r.coverage_status === 'Covered' ? 'status-covered' : 'status-not'}">
          ${r.coverage_status}
        </td>
        <td>${r.condition_text || "-"}</td>
      </tr>
    `;
  });

  html += "</table>";
  document.getElementById("result").innerHTML = html;
}

/* =========================
   CSV Export
========================= */
function exportCSV() {
  const rows = [...document.querySelectorAll("table tr")].map(tr =>
    [...tr.children].map(td => `"${td.innerText}"`).join(",")
  );

  const blob = new Blob([rows.join("\n")], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "coverage_result.csv";
  a.click();
}

/* =========================
   Init
========================= */
loadServiceScopes();
</script>
</body>
</html>
