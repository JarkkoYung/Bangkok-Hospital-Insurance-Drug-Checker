<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Bangkok Hospital Insurance Drug Checker</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root {
    --purple: #6b63d1;
    --green-bg: #eef7ee;
    --green-border: #7bc47f;
    --red-bg: #fdeeee;
    --red-border: #e07a7a;
  }

  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f5f6fa;
    margin: 0;
    padding: 16px;
  }

  .container {
    max-width: 900px;
    margin: auto;
    background: #fff;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.05);
  }

  h1 {
    margin: 0 0 12px 0;
    font-size: 26px;
  }

  .top {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
  }

  label {
    display: block;
    margin-top: 16px;
    font-weight: 600;
  }

  input, select, button {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid #ccc;
  }

  button {
    margin-top: 20px;
    background: var(--purple);
    color: #fff;
    border: none;
    font-weight: 600;
  }

  .results {
    margin-top: 24px;
  }

  .card {
    border-left: 6px solid;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
  }

  .covered {
    background: var(--green-bg);
    border-color: var(--green-border);
  }

  .not-covered {
    background: var(--red-bg);
    border-color: var(--red-border);
  }

  .badges {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
  }

  .badge {
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 600;
  }

  .ok {
    background: #dff2e1;
    color: #1f7a35;
  }

  .no {
    background: #f9d6d6;
    color: #8a1f1f;
  }

  footer {
    text-align: center;
    margin-top: 24px;
    font-size: 14px;
    color: #999;
  }
</style>
</head>

<body>
<div class="container">

  <div class="top">
    <h1 id="title">Bangkok Hospital Insurance Drug Checker</h1>
    <select id="lang" onchange="switchLang()">
      <option value="en">EN</option>
      <option value="th">TH</option>
    </select>
  </div>

  <label id="drugLabel">Drug name</label>
  <input id="drugInput" placeholder="e.g. Paracetamol" />

  <label id="scopeLabel">Service scope</label>
  <select id="scope">
    <option value="OPD">OPD</option>
    <option value="IPD">IPD</option>
    <option value="ER">ER</option>
    <option value="ICU">ICU</option>
  </select>

  <button onclick="checkCoverage()" id="checkBtn">Check coverage</button>

  <div class="results" id="results"></div>

</div>

<footer>Designed by Jarkko</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const db = window.__db || supabase.createClient(
  "https://dtfekjqhnyywjneutbli.supabase.co",
  "sb_publishable_ufJ1KgttNIqvmS46kK8P7g_HuYpAQ5N"
);
window.__db = db;

const i18n = {
  en: {
    title: "Bangkok Hospital Insurance Drug Checker",
    drug: "Drug name",
    scope: "Service scope",
    btn: "Check coverage",
    nodata: "No coverage data found."
  },
  th: {
    title: "ระบบตรวจสอบสิทธิ์ยาประกัน",
    drug: "ชื่อยา",
    scope: "ประเภทบริการ",
    btn: "ตรวจสอบสิทธิ์ยา",
    nodata: "ไม่พบข้อมูลสิทธิ์ยา"
  }
};

function switchLang() {
  const l = lang.value;
  title.textContent = i18n[l].title;
  drugLabel.textContent = i18n[l].drug;
  scopeLabel.textContent = i18n[l].scope;
  checkBtn.textContent = i18n[l].btn;
}

async function checkCoverage() {
  results.innerHTML = "";
  const drug = drugInput.value.trim();
  if (!drug) return;

  // ✅ 修复后的“完美版”查询逻辑
  const { data: rules } = await db
    .from("coverage_rule")
    .select("*")
    .or(
      `drug_name.ilike.%${drug}%,drug_generic_name.ilike.%${drug}%`
    );

  if (!rules || rules.length === 0) {
    results.textContent = i18n[lang.value].nodata;
    return;
  }

  const companyIds = [...new Set(rules.map(r => r.insurance_company_id))];
  const { data: companies } = await db
    .from("insurance_company")
    .select("*")
    .in("id", companyIds);

  const grouped = {};
  rules.forEach(r => {
    const c = companies.find(x => x.id === r.insurance_company_id);
    if (!grouped[r.insurance_company_id]) {
      grouped[r.insurance_company_id] = {
        name: c?.name || "Unknown",
        rules: []
      };
    }
    grouped[r.insurance_company_id].rules.push(r);
  });

  Object.values(grouped).forEach(g => {
    const hasCovered = g.rules.some(r => r.coverage_status === "COVERED");
    const card = document.createElement("div");
    card.className = "card " + (hasCovered ? "covered" : "not-covered");

    card.innerHTML = `
      <strong>${g.name}</strong>
      <div class="badges">
        ${g.rules.map(r => `
          <span class="badge ${r.coverage_status === "COVERED" ? "ok" : "no"}">
            ${r.service_scope}
          </span>
        `).join("")}
      </div>
    `;
    results.appendChild(card);
  });
}

switchLang();
</script>
</body>
</html>
