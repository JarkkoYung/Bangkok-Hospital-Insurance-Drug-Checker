<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bangkok Hospital Insurance Drug Checker</title>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f7fb;
      padding: 40px;
      color: #1f2937;
    }

    .card {
      max-width: 900px;
      margin: auto;
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 20px 40px rgba(0,0,0,.08);
    }

    h1 {
      font-size: 36px;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #6b7280;
      margin-bottom: 32px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      margin-top: 24px;
    }

    input, select {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
    }

    button {
      margin-top: 32px;
      width: 100%;
      padding: 16px;
      font-size: 18px;
      font-weight: 700;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 14px;
      cursor: pointer;
    }

    button:hover {
      background: #1d4ed8;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 40px;
    }

    th, td {
      text-align: left;
      padding: 14px;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      background: #f9fafb;
      font-weight: 700;
    }

    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
    }

    .badge-covered {
      background: #ecfdf5;
      color: #065f46;
    }

    .badge-not {
      background: #fef2f2;
      color: #991b1b;
    }

    .badge-conditional {
      background: #fffbeb;
      color: #92400e;
    }

    .message {
      margin-top: 32px;
      padding: 16px;
      background: #f1f5f9;
      border-radius: 12px;
      color: #334155;
    }
  </style>
</head>
<body>

<div class="card">
  <h1>Bangkok Hospital Insurance Drug Checker</h1>
  <p class="subtitle">Check insurance coverage by drug and service scope</p>

  <label>Drug name</label>
  <input id="drugInput" placeholder="e.g. Paracetamol" />

  <label>Service scope</label>
  <select id="scopeSelect">
    <option>Loading...</option>
  </select>

  <button onclick="checkCoverage()">Check coverage</button>

  <div id="result"></div>
</div>

<script>
  /* ===============================
     üîê Supabase configÔºà‰Ω†Âè™ÊîπÈÄôË£°Ôºâ
     =============================== */
  const SUPABASE_URL = "https://dtfekjqhnyywjneutbli.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_ufJ1KgttNIqvmS46kK8P7g_HuYpAQ5N";

  const supabase = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  /* ===============================
     Load service scopes
     =============================== */
  async function loadServiceScopes() {
    const select = document.getElementById("scopeSelect");

    const { data, error } = await supabase
      .from("service_scope")
      .select("id, name")
      .order("name");

    if (error) {
      select.innerHTML = "<option>Error loading service scopes</option>";
      return;
    }

    select.innerHTML = `<option value="">Select service scope</option>`;
    data.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.name;
      opt.textContent = s.name;
      select.appendChild(opt);
    });
  }

  loadServiceScopes();

  /* ===============================
     Coverage lookup
     =============================== */
  async function checkCoverage() {
    const drug = document.getElementById("drugInput").value.trim();
    const scope = document.getElementById("scopeSelect").value;
    const resultDiv = document.getElementById("result");

    resultDiv.innerHTML = "";

    if (!drug || !scope) {
      resultDiv.innerHTML = `<div class="message">Please enter a drug name and select a service scope.</div>`;
      return;
    }

    const { data, error } = await supabase
      .from("coverage_rule")
      .select(`
        coverage_status,
        condition_text,
        insurance_company:insurance_company_id(name),
        drug:drug_id(generic_name),
        service_scope:service_scope_id(name)
      `)
      .ilike("drug.generic_name", `%${drug}%`)
      .eq("service_scope.name", scope);

    if (error || !data || data.length === 0) {
      resultDiv.innerHTML = `
        <div class="message">
          No coverage rules found for this drug and service scope.<br/>
          Please confirm with the insurance desk.
        </div>`;
      return;
    }

    let html = `
      <table>
        <tr>
          <th>Insurance Company</th>
          <th>Coverage Status</th>
          <th>Conditions</th>
        </tr>
    `;

    const statusMap = {
      covered: { label: "Covered", class: "badge-covered", icon: "‚úÖ" },
      not_covered: { label: "Not Covered", class: "badge-not", icon: "‚ùå" },
      conditional: { label: "Covered with Conditions", class: "badge-conditional", icon: "‚ö†Ô∏è" }
    };

    data.forEach(r => {
      const status = statusMap[r.coverage_status] || {
        label: r.coverage_status,
        class: "",
        icon: ""
      };

      html += `
        <tr>
          <td>${r.insurance_company.name}</td>
          <td>
            <span class="badge ${status.class}">
              ${status.icon} ${status.label}
            </span>
          </td>
          <td>${r.condition_text ? r.condition_text : "‚Äî"}</td>
        </tr>
      `;
    });

    html += "</table>";
    resultDiv.innerHTML = html;
  }
</script>

</body>
</html>
